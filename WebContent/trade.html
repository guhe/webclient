<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>交易</title>
<link rel="stylesheet" href="css/style.css" type="text/css" />
<script src="jquery-3.0.0.js"></script>
<script src="extends.js"></script>
<script>
	var portfolioId = $.getUrlVar("id");

	function loadTradeRecord() {
		$.get({
			url : "rest/Portfolio/" + portfolioId + "/Trade",
			dataType : 'json',
			success : function(result) {
				$("#detail tbody tr").remove();
				
				result.sort(function(a, b) {
					return a["date"] > b["date"];
				});
				$.each(result, function(key, row_data) {
					var isBuy = row_data["buyOrSell"] == "BUY";
					var row = $("<tr/>").appendTo($("#detail tbody"));
					$("<td/>").html(isBuy ? "买入" : "卖出").appendTo(row); // 交易方向
					$("<td/>").html(row_data["stockName"] + row_data["stockCode"]).appendTo(row); // 股票代码
					$("<td/>").html(row_data["amount"]).appendTo(row); // 成交数量
					$("<td/>").html(row_data["price"]).appendTo(row); // 成交价格
					$("<td/>").html(row_data["fee"]).appendTo(row); // 成交价格
					$("<td/>").html(row_data["date"]).appendTo(row); // 成交日期

					console.log(row_data, isBuy);

					if (isBuy) {
						row.css("background", "#800");
					} else {
						row.css("background", "#080");
					}
				});
			},
		});
	}

	function addTradeRecord() {
		var data = {};
		data["buyOrSell"] = $(".trade input[name='buyOrSell']:checked").val();
		data["stockCode"] = $(".trade input[name='stockCode']").val();
		data["amount"] = $(".trade input[name='amount']").val() * 1;
		data["price"] = $(".trade input[name='price']").val() * 1;
		data["fee"] = $(".trade input[name='fee']").val() * 1;
		data["date"] = $(".trade input[name='date']").val();

		$.post({
			url : "rest/Portfolio/" + portfolioId + "/Trade",
			contentType : "application/json; charset=utf-8",
			dataType : 'json',
			data : JSON.stringify(data),
			async : false,
			success : function(result) {
				if (result["rltCode"] == 0) {
					$("#tradeTip span").text("操作成功。");
					
					loadTradeRecord();
				} else {
					$("#tradeTip span").text(result["message"]);
				}
			},
			error : function() {
				$("#tradeTip span").text("操作失败。");
			}
		});
	}

	$(document).ready(function() {
		$.get({
			url : "rest/Portfolio/" + portfolioId,
			dataType : 'json',
			async : false,
			success : function(result) {
				$('title').text("交易-" + result["name"]);
			},
		});

		$(".trade form").submit(function(event) {
			event.preventDefault();

			addTradeRecord();
		});

		loadTradeRecord();
	});
</script>
</head>
<body>
	<div style="height: 50px"></div>
	<div align="center">
		<div id="detail">
			<table class="zebra">
				<caption>
					<span>交易记录</span>
				</caption>
				<thead>
					<tr>
						<th>交易方向</th>
						<th>股票代码</th>
						<th>成交数量</th>
						<th>成交价格</th>
						<th>交易费用</th>
						<th>成交日期</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div style="height: 20px"></div>
		<div class="trade" align="center">
			<form>
				<table>
					<tr>
						<td><span>交易方向：</span></td>
						<td align="center"><input type="radio" name="buyOrSell"
							value="BUY" checked="checked">买<input type="radio"
							name="buyOrSell" value="SELL">卖</td>
					</tr>
					<tr>
						<td><span>股票代码：</span></td>
						<td><input type="text" name="stockCode"></td>
					</tr>
					<tr>
						<td><span>成交数量：</span></td>
						<td><input type="text" name="amount"></td>
					</tr>
					<tr>
						<td><span>成交价格：</span></td>
						<td><input type="text" name="price"></td>
					</tr>
					<tr>
						<td><span>交易费用：</span></td>
						<td><input type="text" name="fee"></td>
					</tr>
					<tr>
						<td><span>交易日期：</span></td>
						<td><input type="text" name="date"></td>
					</tr>
					<tr>
						<td colspan="2" align="center"><input type="submit"
							value="确定"></td>
					</tr>
				</table>
			</form>
		</div>
		<p id="tradeTip">
			<span></span>
		</p>
	</div>
</body>
</html>